<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Pong!</title>

  <style>
canvas {
  display: block;
  position: absolute;
  margin: auto;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
}
  body {
   background-color: lightblue;
  }
  </style>

  </head>
  <body>

 <p><a href="http://carlosgreenpersonalsite.com">Back to the homepage</a></p>

    <h1>Ping Pong!</h1>
    <p>Use the Up and Down arrow keys</p>
    <br/>

    <div id="canvas"></div>

<script>
"use strict"
/**
* Constants
*/
var WIDTH = 700;
var HEIGHT = 600;
var pi = Math.PI;
var UpArrow = 38;
var DownArrow = 40;
var canvas;
var ctx;
var keystate;
var player = {
  x: null,
  y: null,
  width: 20,
  height: 100,
  update: function() {
    if (keystate[UpArrow]) this.y -= 7;
    if (keystate[DownArrow]) this.y += 7;
    this.y = Math.max(Math.min(this.y, HEIGHT - this.height), 0)  
  },

  draw: function() {
    ctx.fillRect(this.x, this.y, this.width, this.height)
  }
},

ai = {
  x: null,
  y: null,
  width: 20,
  height: 100,

/**
Update the position depending on the ball position
**/
  update: function() {
    var desty = ball.y - (this.height - ball.size)*0.5;
  // ease the movement towards the ideal position
    this.y += (desty - this.y) * 0.1;
  // keep the paddle inside of the canvas
    this.y = Math.max(Math.min(this.y, HEIGHT - this.height), 0)
  },

/**
Draw the ai paddle to the canvas
**/
  draw: function() {
    ctx.fillRect(this.x, this.y, this.width, this.height)
  }
},

/**
The ball object
**/

ball = {
  x: null,
  y: null,
  vel: null,
  side: 20,
  speed: 12,
/**
*Serve the ball
 * @param {number} 1 right
 * 		  -1		
**/

  serve: function(side) {
    var r = Math.random()
    this.x = side === 1 ? player.x + player.width : ai.x - this.side;
    this.y = (HEIGHT - this.side)*r;

// calculate out-angle, higher/lower on y axis
// steeper angle
    var phi = 0.1*pi*(1 - 2*r);
// set velocity direction and magnitude
    this.vel = {
      x: side*this.speed*Math.cos(phi),
      y: this.speed*Math.sin(phi)	    
    }
  },

// Update the ball position
  update: function() {

// update position with current velocity
    this.x += this.vel.x;
    this.y += this.vel.y;

// check if out of the canvas in the y direction
    if (0 > this.y || this.y+this.side > HEIGHT) {

// calculate and add the right offset,
      var offset = this.vel.y < 0 ? 0 - this.y : HEIGHT - (this.y+this.side)	  
      this.y += 2 * offset;

// mirror the y velocity
      this.vel.y *= -1	  
  }	  

// helper function to check intersection 
  var AABBIntersect = function(ax, ay, aw, ah, bx, by, bw, bh) {
    return ax < bx+bw && ay < by+bh && bx < ax+aw && by < ay+ah;
  }	  
  
// check againts target paddle direction
    var pdle = this.vel.x < 0 ? player : ai;
  if (AABBIntersect(pdle.x, pdle.y, pdle.width, pdle.height, this.x, this.y, this.side, this.side)) {

// set the x position and calculate reflection angle
    this.x = pdle === player ? player.x+player.width : ai.x - this.side;
    var n = (this.y+this.side - pdle.y)/(pdle.height+this.side)
    var phi = 0.25*pi*(2*n - 1);

// calculate smash value and update velocity
    var smash = Math.abs(phi) > 0.2*pi ? 1.5 : 1;
    this.vel.x = smash*(pdle === player ? 1 : -1)*this.speed*Math.cos(phi)
    this.vel.y = smash*this.speed*Math.sin(phi)	  
  }	  

// reset the ball when ball outside of the canvas
  if (0 > this.x + this.side || this.x > WIDTH) {
    this.serve(pdle === player ? 1 : -1)
  }	  
},

// draw the ball to the canvas  
  draw: function() {
    ctx.fillRect(this.x, this.y, this.side, this.side)
  }
}

// Starts the game
function main() {
  canvas = document.createElement("canvas")
  canvas.width = WIDTH;
  canvas.height = HEIGHT;
  ctx = canvas.getContext("2d")
  document.body.appendChild(canvas)

  keystate = {};
// keep track of keyboard presses
  document.addEventListener("keydown", function(e) {
    keystate[e.keyCode] = true;
  });

  document.addEventListener("keyup", function(e) {
    delete keystate[e.keyCode]
  });

  init(); // initiate game objects

// game loop function
var loop = function() {
  update();
  draw();
  window.requestAnimationFrame(loop, canvas)
  }
  window.requestAnimationFrame(loop, canvas)	
}

// Initiate game objects and set start positions
function init() {
  player.x = player.width;
  player.y = (HEIGHT - player.height)/2;
  
  ai.x = WIDTH - (player.width + ai.width)
  ai.y = (HEIGHT - ai.height)/2;

  ball.serve(1);	
}

// update all game objects
function update() {
  ball.update();
  player.update()
  ai.update()	
}

// clear canvas and draw all game objects

function draw() {
  ctx.fillRect(0, 0, WIDTH, HEIGHT)

  ctx.save()

  ctx.fillStyle = "lightblue";

  ball.draw()
  player.draw()
  ai.draw()

// draw the net
  var w = 4;
  var x = (WIDTH - w)*0.5;
  var y = 0;
  var step = HEIGHT/20;
  while(y < HEIGHT) {
    ctx.fillRect(x, y+step*0.25, w, step*0.5)
    y += step;	  
  }
  ctx.restore()	
}
main()
  </script> 
 </body>
</html>
